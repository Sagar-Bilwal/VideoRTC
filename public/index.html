<!DOCTYPE html>
<html>

<head>
	<title>Whiteboard</title>

	<!--- JS References -!-->
	<script type="text/javascript" src="./js/jquery-3.2.1.min.js"></script>
	<script type="text/javascript" src="./js/jquery-ui.min.js"></script>
	<!--- for dragabbles -!-->
	<script type="text/javascript" src="./js/socketio2.0.4.min.js"></script>
	<script type="text/javascript" src="./js/jqColorPicker.min.js"></script>

	<script type="text/javascript" src="./js/whiteboard.js"></script>
	<script type="text/javascript" src="./js/main.js"></script>
	<script type="text/javascript" src="./SFMediaStream.min.js"></script>

	<!--- CSS References -!-->
	<link rel="stylesheet" href="./css/jquery-ui.min.css">
	<link href="./css/fontawesome-all.min.css" rel="stylesheet">
	<link href="./css/main.css" rel="stylesheet">
	 <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M"
    crossorigin="anonymous">
  <link rel="stylesheet" type="text/css" href="styles.css">

</head>
<body>
<div class="chat" style="width:30%;">
  
	<div class="chat__sidebar">
  <h3>People</h3>
  <div id="users"></div>
	</div>
	<div class="chat__main">
  <ol id = "messages" class="chat__messages"></ol>
	<div class="chat__footer">
   <form id="message-form">
	 
	<input name = "message" type="text" placeholder="Message"/>
	  <button>send</button>
	</form>
	<br> <br>
	<button id = "send-location">Send Location</button>
  
	</div>
	</div>
   <script id="message-template" type = "text/template">
   <li class ="message">
   <div class ="message__title">
	   <h4>{{from}}</h4>
	   <span>{{createAt}}</span>
   </div>
   <div class = "message__body">
	   <p>{{text}}</p>
   </div>
  </li>
  
   </script>
   <script id="location-message-template" type = "text/template">
	  <li class ="message">
	  <div class ="message__title">
		  <h4>{{from}}</h4>
		  <span>{{createAt}}</span>
	  </div>
	  <div class = "message__body">
		  <p>
			  <a href ="{{url}}" target="_blank">My current location</a>
		  </p>
	  </div>
	 </li>
	 
	  </script>
	</div>
<div style="position: relative; margin: 0px; height: 90vh; width: 70%; overflow: hidden; float: left;" >
	  	  
	<!---Whiteboard container -!-->
	<div style="height: 100vh; width: 100%;" id="whiteboardContainer"></div>

	<!---Toolbar -!-->
	<div style="position: absolute; top: 10px; left: 10px;">
		<div class="btn-group">
			<button id="whiteboardTrashBtn" title="Clears the whiteboard" type="button" class="whiteboardBtn">
				<i class="fa fa-trash"></i>
			</button>
			<button id="whiteboardUndoBtn" title="Undo your last step" type="button" class="whiteboardBtn">
				<i class="fa fa-undo"></i>
			</button>
		</div>

		<div class="btn-group">
			<button tool="mouse" title="Take the mouse" type="button" class="whiteboardTool">
				<i class="fa fa-mouse-pointer"></i>
			</button>
			<button style="padding-bottom: 11px;" tool="recSelect" title="Select an area" type="button" class="whiteboardTool">
				<img src="./img/dottedRec.png">
			</button>
			<button tool="pen" title="Take the pen" type="button" class="whiteboardTool active">
				<i class="fa fa-pencil-alt"></i>
			</button>
			<button style="padding-bottom: 8px; padding-top: 7px;" tool="line" title="draw a line" type="button" class="whiteboardTool">
			</button>
			<button tool="rect" title="draw a rectangle" type="button" class="whiteboardTool">
				<i class="far fa-square"></i>
			</button>
			<button tool="circle" title="draw a circle" type="button" class="whiteboardTool">
				<i class="far fa-circle"></i>
			</button>
			<button tool="eraser" title="take the eraser" type="button" class="whiteboardTool">
				<i class="fa fa-eraser" aria-hidden="true"></i>
			</button>
		</div>

		<div style="width: 190px;  height: 44px; border: 1px solid green;" class="btn-group">
			<img style="position: absolute; left: 11px; top: 16px; height:14px; width:130px;" src="./img/slider-background.svg">
			<input title="Thickness" id="whiteboardThicknessSlider" style="position: absolute; left:9px; width: 130px; top: 15px;" type="range"
			 min="1" max="50" value="3">
			<div title="Colorpicker" style="position: absolute; left: 155px; top: 10px; width: 26px; height: 23px; border-radius: 3px; overflow: hidden; border: 1px solid darkgrey;">
				<div id="whiteboardColorpicker" value="#000000" style="width: 40px; height: 35px; border: 0px; padding: 0px; position: relative; top: 0px; left: -5px;"></div>
			</div>
		</div>

		<div class="btn-group">
			<button id="saveAsImageBtn" title="Save whiteboard as image" type="button" class="whiteboardBtn">
				<i class="fas fa-image"></i>
				<i style="position: absolute; top: 3px; left: 2px; color: #000000; background: grey; font-size: 0.5em; " class="fas fa-save"></i>
			</button>
			<button style="position: relative;" id="saveAsJSONBtn" title="Save whiteboard as JSON" type="button" class="whiteboardBtn">
				<i class="far fa-file-alt"></i>
				<i style="position: absolute; top: 3px; left: 2px; color: #000000; background: grey; font-size: 0.5em; " class="fas fa-save"></i>
			</button>
		</div>

		<div class="btn-group">
			<button id="addImgToCanvasBtn" title="Upload Image to whiteboard" type="button" class="whiteboardBtn">
				<i class="fas fa-image"></i>
				<i style="position: absolute; top: 3px; left: 2px; color: #000000; font-size: 0.5em; " class="fas fa-upload"></i>
			</button>
			<button style="position: relative;" id="uploadJsonBtn" title="Load saved JSON to whiteboard" type="button" class="whiteboardBtn">
				<i class="far fa-file-alt"></i>
				<i style="position: absolute; top: 3px; left: 2px; color: #000000; font-size: 0.5em; " class="fas fa-upload"></i>
			</button>
			<input style="display:none;" id="myFile" type="file" />
		</div>
		</div>
</div>
		<div>
			<button onclick="asPresenter()" class="btn btn-danger">Presenter</button>
	<button onclick="asStreamer()" class="btn btn-danger">Streamer</button>
	<button onclick="streamerEffect()">Effect (for streamer)</button>
	<input type="text" id="debug"><br>
		</div>

	<script src="/socket.io/socket.io.js"></script>
	  <!-- <script type = 'text/javascript' src="./js/libs/jquery-3.3.1.min.js"></script> -->
	  <script src="./js/libs/moment.js"></script>
	  <script filetype = "html.mustache"src="./js/libs/mustache.js"></script>
	  
	  </script>
	  <script type="text/javascript" src="./js/chat.js"></script>
		<!-- <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
		  crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4"
		  crossorigin="anonymous"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1"
		  crossorigin="anonymous"></script> -->
		<script src="./js/libs/deparam.js"></script>
		
	<script type="text/javascript">
		var mySocket = io("/", {transports:['websocket']});
		var debug = document.querySelector('#debug');
			
		// ===== Presenter =====
		var presenterMedia = false;
		function asPresenter(){
			if(presenterMedia === false){
				// Set latency to 100ms (Equal with streamer)
				presenterMedia = new ScarletsMediaPresenter({
				    audio:{
				        channelCount:1,
				        echoCancellation: false
				    }
				}, 100);

				presenterMedia.onRecordingReady = function(packet){
				    console.log("Recording started!");
				    console.log("Header size: " + packet.data.size);

				    // Every new client streamer must receive this header buffer data
				    mySocket.emit('bufferHeader', packet);
				}

				presenterMedia.onBufferProcess = function(streamData){
					debug.value = "Buffer sent: " + streamData[0].size + "bytes";
				    mySocket.emit('stream', streamData);
				}
			}

			presenterMedia.startRecording();
		}

		// ===== Streamer =====
		var audioStreamer = false;
		function asStreamer(){
			if(audioStreamer === false){
				// Set latency to 100ms (Equal with presenter)
				console.log('d\hey')
				audioStreamer = new ScarletsAudioStreamer(100);
				audioStreamer.playStream();

				// Buffer header must be received first
				mySocket.on('bufferHeader', function(packet){
				    audioStreamer.setBufferHeader(packet);
				});

				// Receive buffer and play it
				mySocket.on('stream', function(packet){
					debug.value = "Buffer received: "+packet[0].byteLength+"bytes";
				    audioStreamer.receiveBuffer(packet);
				});
			}

			// Request buffer header
			mySocket.emit('requestBufferHeader', '');
		}

	//	===== Streamer Audio Effect =====
		function streamerEffect(){
			if(audioStreamer === false){
				console.error("Streamer haven't been initialized");
				return;
			}

			var ppDelay = ScarletsMediaEffect.pingPongDelay();

			// Stream (source) -> Ping pong delay -> destination
			audioStreamer.connect(ppDelay.input);
			ppDelay.output.connect(ScarletsMedia.audioContext.destination);
		}
	</script>
		  
</body>

</html>